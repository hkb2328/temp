from databricks_langchain import DatabricksEmbeddings, ChatDatabricks
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_community.document_loaders import PyPDFLoader
from langchain_community.vectorstores import FAISS
import os

# ---------- CONFIG ----------
pdf_path = "/Workspace/Users/your.name@example.com/sample.pdf"  # Change path to your PDF file in Databricks
embedding_endpoint = "databricks-bge-large-en"  # or whatever embedding endpoint you used earlier
chat_endpoint = "databricks-dbrx-instruct"      # or "databricks-meta-llama-3-70b-instruct"
# ----------------------------

# 1Ô∏è‚É£ Load PDF
loader = PyPDFLoader(pdf_path)
docs = loader.load()
print(f"‚úÖ Loaded {len(docs)} pages from {pdf_path}")

# 2Ô∏è‚É£ Split text into chunks
splitter = RecursiveCharacterTextSplitter(chunk_size=1000, chunk_overlap=200)
chunks = splitter.split_documents(docs)
print(f"‚úÖ Split into {len(chunks)} chunks")

# 3Ô∏è‚É£ Create embeddings using Databricks model
embedding_model = DatabricksEmbeddings(endpoint=embedding_endpoint)

# 4Ô∏è‚É£ Create FAISS vector store (in-memory)
vectorstore = FAISS.from_documents(chunks, embedding_model)
retriever = vectorstore.as_retriever(search_kwargs={"k": 5})
print("‚úÖ FAISS index created")

# 5Ô∏è‚É£ Initialize Databricks chat model
llm = ChatDatabricks(endpoint=chat_endpoint)

# 6Ô∏è‚É£ Define retrieval + generation manually (no chains)
def rag_answer(query: str):
    # Retrieve relevant chunks
    retrieved_docs = retriever.get_relevant_documents(query)
    context = "\n\n".join([doc.page_content for doc in retrieved_docs])

    # Build prompt for the LLM
    prompt = f"""
    You are a helpful assistant. Use the following context to answer the question.

    Context:
    {context}

    Question:
    {query}

    Answer:
    """

    # Call Databricks chat model
    try:
        response = llm.predict(prompt)
    except Exception:
        response = llm.invoke(prompt)

    return response

# 7Ô∏è‚É£ Test it
question = "Summarize the key points of this document."
answer = rag_answer(question)
print("üîπQuestion:", question)
print("üîπAnswer:", answer)
